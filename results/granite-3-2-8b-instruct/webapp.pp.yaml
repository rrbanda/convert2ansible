---
- name: Deploy rail webapp
  hosts: all
  become: yes
  gather_facts: yes
  tasks:
    - name: deploy rail webapp
      become_user: rails
      become_method: sudo
      block:
        - name: deploy rail webapp
          become: true
          become_method: sudo
          block:
            - name: clone git repository
              become: true
              become_method: sudo
              block:
                - name: get service webapp repo
                  block:
                    - name: set up git credentials
                      become: true
                      become_method: sudo
                      block:
                        - name: add ssh key
                          block:
                            - name: generate ssh key
                              block:
                                - name: copy ssh key
                                  block:
                                    - name: set up git credentials
                                      block:
                                        - name: get service webapp repo
                                          block:
                                            - name: clone git repository
                                              block:
                                                - name: fetch webapp tag
                                                  block:
                                                    - name: checkout webapp tag
                                                      block:
                                                        - name: install gems
                                                          block:
                                                            - name: bundle install
                                                              block:
                                                                - name: generate secret
                                                                  block:
                                                                    - name: set up unicorn
                                                                      block:
                                                                        - name: set up apache
                                                                          block:
                                                                            - name: create vhost
                                                                              block:
                                                                                - name: configure vhost
                                                                                  block:
                                                                                    - name: enable vhost
                              block:
                                - name: set up mysql database
                                  block:
                                    - name: create database
                                      block:
                                        - name: grant privileges
                                          block:
                                            - name: start unicorn
                                              block:
                                                - name: start apache
                                                  block:
                                                    - name: reload apache
                                                      block:
                                                        - name: restart unicorn
                                                          block:
                                                            - name: restart mysql
                                                              block:
                                                                - name: enable mysql service
                                                                  block:
                                                                    - name: set up redmine
                                                                      block:
                                                                        - name: configure redmine
                                          block:
                                            - name: start redmine
                                              block:
                                                - name: reload apache
                                                  block:
                                                    - name: restart unicorn
                                                      block:
                                                        - name: restart mysql
                                                          block:
                                                            - name: enable mysql service