- name: Deploy rail webapp
  hosts: all
  become: true
  tasks:
  - name: Create directory for webapps
    file:
      path: /opt/webapps
      state: directory
  - name: Install dependencies
    package:
      name:
      - rubygems
      - ruby-dev
      - libxml2-dev
      - libxslt-dev
      - libsqlite3-dev
      - libmysqlclient-dev
    become: true
  - name: Install bundler
    package:
      name: bundler
    become: true
    require:
    - Package["rubygems"]
  - name: Set up apache module
    apache::module:
      name: proxy_http
    become: true
  - name: Create webapp directory
    file:
      path: /opt/webapps
      state: directory
  - name: Fetch webapp repo
    exec:
      command: git clone {{ service_webapp_repo }} /opt/webapps
    become: true
    create_mode: 493
    require:
    - File['/opt/webapps']
  - name: Fetch webapp tag
    exec:
      command: git checkout {{ service_webapp_tag }}
    become: true
    cwd: /opt/webapps
    path: /usr/bin/:/usr/local/bin/:/bin/
    require:
    - Exec['fetch webapp repo']
  - name: Install unicorn
    file:
      path: /opt/webapps/Gemfile.local
      content: 'gem ''unicorn''

        '
    become: true
    require:
    - Exec['fetch webapp tag']
    - Package["bundler"]
  - name: Run bundle install
    exec:
      command: bundle install --without development test rmagick postgresql
    become: true
    cwd: /opt/webapps
    path: /usr/bin/:/usr/local/bin/:/bin/
    require:
    - File['Gemfile.local']
    - Package["bundler"]
  - name: Generate secret
    exec:
      command: bundle exec rake generate_session_store
    become: true
    cwd: /opt/webapps
    path: /usr/bin/:/usr/local/bin/:/bin/
    require:
    - Exec['bundle install']
  - name: Configure database
    template:
      src: webapp/database.yml.erb
      dest: /opt/webapps/config/database.yml
    become: true
    require:
    - Exec['bundle install']
  - name: Run rake tasks
    exec:
      command: bundle exec rake db:migrate RAILS_ENV=production && bundle exec rake
        redmine:load_default_data RAILS_ENV=production REDMINE_LANG=en
    become: true
    cwd: /opt/webapps
    path: /usr/bin/:/usr/local/bin/:/bin/
    require:
    - File['Gemfile.local']
    - Exec['generate secret']
  - name: Set up unicorn user
    user:
      name: rails
      group: rails
      comment: rails
      membership: minimum
      shell: /bin/sh
      home: /opt/webapps
      require:
      - Exec['fetch webapp repo']
  - name: Change ownership of files
    file:
      path:
      - /opt/webapps/files
      - /opt/webapps/log
      - /opt/webapps/tmp
      - /opt/webapps/public
      owner: rails
      mode: '0755'
    become: true
  - name: Start unicorn
    upstart:
      name: unicorn
      description: unicorn app server
      command: start-stop-daemon --start -c rails -d /opt/webapps --exec /usr/local/bin/bundle
        -- exec unicorn_rails -E production
    become: true
    require:
    - Exec['rake tasks']
    - Exec['generate secret']
  - name: Disable default vhost
    exec:
      command: /usr/sbin/a2dissite default
    become: true
  - name: Create apache vhost
    template:
      src: webapp/webapp.erb
      dest: /etc/apache2/sites-available/webapp
    become: true
    require:
    - Exec['rake tasks']
    - Exec['generate secret']
    - Exec['disable default vhost']
